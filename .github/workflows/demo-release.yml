name: Demo Release

on:
  workflow_dispatch:
  push:
    tags:
      - demo-*

env:
  BUILD_TYPE: Release

jobs:
  Output-Envs:
    name: Read .env file and expose it as output
    runs-on: ubuntu-latest
    outputs:
      VCPKG_DEPS_TAG: ${{ env.VCPKG_DEPS_TAG }}
    steps:
      - uses: actions/checkout@v4
      - run: cat "${{ github.workspace }}/CI/github.env" >> $GITHUB_ENV

  Windows:
    needs:
      - Output-Envs
    uses: ./.github/workflows/windows.yml
    with:
      image: "2022"
      vcpkg-deps-tag: ${{ needs.Output-Envs.outputs.VCPKG_DEPS_TAG }}
      build-type: Release
      package: true

  Linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Add OpenMW PPA Dependencies
      run: sudo add-apt-repository ppa:openmw/openmw; sudo apt-get update

    - name: Install Building Dependencies
      run: sudo CI/install_debian_deps.sh gcc openmw-deps openmw-deps-dynamic

    - name: Prime ccache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: linux-demo-${{ env.BUILD_TYPE }}
        max-size: 1000M

    - name: Configure
      run: >
        cmake .
        -D CMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        -D OPENMW_USE_SYSTEM_RECASTNAVIGATION=ON
        -D USE_SYSTEM_TINYXML=ON
        -D CMAKE_INSTALL_PREFIX=install

    - name: Build
      run: cmake --build . -- -j$(nproc)

    - name: Install
      run: cmake --install .

    - name: Package
      run: tar czf openmw-linux-x64.tar.gz -C install .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: openmw-linux-x64
        path: openmw-linux-x64.tar.gz

  macOS-ARM64:
    runs-on: macos-15

    steps:
    - uses: actions/checkout@v4

    - name: Install Building Dependencies
      run: CI/before_install.macos.sh

    - name: Prime ccache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: macos-arm64-demo-${{ env.BUILD_TYPE }}
        max-size: 1000M

    - name: Configure
      env:
        CMAKE_BUILD_TYPE: ${{ env.BUILD_TYPE }}
      run: CI/before_script.macos.sh -C

    - name: Build
      run: CI/macos/build.sh

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: openmw-macos-arm64
        path: build/*.dmg

  macOS-x64:
    runs-on: macos-15

    env:
      MACOS_AMD64: 1

    steps:
    - uses: actions/checkout@v4

    - name: Install Building Dependencies
      run: CI/before_install.macos.sh

    - name: Prime ccache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: macos-x64-demo-${{ env.BUILD_TYPE }}
        max-size: 1000M

    - name: Configure
      env:
        CMAKE_BUILD_TYPE: ${{ env.BUILD_TYPE }}
      run: CI/before_script.macos.sh -C

    - name: Build
      run: CI/macos/build.sh

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: openmw-macos-x64
        path: build/*.dmg

  Create-Release:
    if: startsWith(github.ref, 'refs/tags/demo-')
    needs:
      - Windows
      - Linux
      - macOS-ARM64
      - macOS-x64
    runs-on: ubuntu-latest

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create release
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/**/*
        prerelease: true
        draft: false
        generate_release_notes: true
