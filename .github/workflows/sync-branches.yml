name: Sync topic branches and rebuild merged

on:
  workflow_dispatch:

# Topic branches: each rebased independently onto master.
# Merged branch: recreated from scratch by merging all topics.
env:
  TOPIC_BRANCHES: >-
    topic/msoc
    topic/shadows
    topic/physics
  MERGED_BRANCH: wip-merged

permissions:
  contents: write

jobs:
  sync-topics:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch all remote branches
      run: git fetch origin

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Rebase topic branches onto master
      run: |
        failed=""
        succeeded=""
        skipped=""

        for branch in $TOPIC_BRANCHES; do
          echo "========================================="
          echo "Rebasing $branch onto master"
          echo "========================================="

          if ! git rev-parse --verify "origin/$branch" >/dev/null 2>&1; then
            echo "  -> $branch not found on remote, skipping"
            skipped="$skipped\n  $branch"
            echo ""
            continue
          fi

          git checkout "$branch"

          if git rebase origin/master; then
            git push --force-with-lease origin "$branch"
            echo "  -> $branch rebased and pushed"
            succeeded="$succeeded\n  $branch"
          else
            git rebase --abort
            echo "  -> $branch has conflicts, skipping"
            failed="$failed\n  $branch"
          fi

          echo ""
        done

        echo "========================================="
        echo "REBASE SUMMARY"
        echo "========================================="
        if [ -n "$succeeded" ]; then
          echo -e "Succeeded:$succeeded"
        fi
        if [ -n "$skipped" ]; then
          echo -e "Skipped (not on remote):$skipped"
        fi
        if [ -n "$failed" ]; then
          echo -e "Failed (conflicts):$failed"
          echo "::warning::Branches with rebase conflicts:$failed"
        fi

    - name: Rebuild merged branch
      run: |
        echo "========================================="
        echo "Rebuilding $MERGED_BRANCH"
        echo "========================================="

        git checkout -B "$MERGED_BRANCH" origin/master

        merge_failed=""
        for branch in $TOPIC_BRANCHES; do
          # Only merge topics that exist on remote
          if ! git rev-parse --verify "origin/$branch" >/dev/null 2>&1; then
            echo "  -> $branch not on remote, skipping merge"
            continue
          fi

          echo "Merging $branch..."
          if git merge --no-ff "origin/$branch" -m "Merge $branch"; then
            echo "  -> merged $branch"
          else
            git merge --abort
            echo "  -> CONFLICT merging $branch, aborting"
            merge_failed="$merge_failed\n  $branch"
          fi
        done

        if [ -n "$merge_failed" ]; then
          echo "::warning::Failed to merge into $MERGED_BRANCH:$merge_failed"
          echo -e "Merge failures:$merge_failed"
        else
          git push --force-with-lease origin "$MERGED_BRANCH"
          echo "  -> $MERGED_BRANCH pushed"
        fi
